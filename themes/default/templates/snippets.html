{% extends "base.html" %}

{% block title %}Snippets - {{ site.title }}{% endblock %}

{% block content %}
{{ component(name="page_tags", title="Snippets", page_url="/snippets.html") | safe }}

{{ component(name="grid_cards", title="Snippets", items=snippets, columns=3, empty_message="No snippets found.") | safe }}

<!-- Snippet Modal Component -->
{{ component(name="snippet_card_modal") | safe }}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Wait for snippet_card_modal.js to initialize
    setTimeout(() => {
        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            // If we're going back from a modal URL, close the modal
            if (window.closeSnippetModal) {
                const modalOverlay = document.querySelector('.snippet-modal-overlay');
                if (modalOverlay && modalOverlay.classList.contains('active')) {
                    window.closeSnippetModal();
                    // Go back to snippets.html
                    history.replaceState({}, '', '/snippets.html');
                }
            }
        });
        
        // Check for modal parameter in URL (for direct snippet URL access)
        const urlParams = new URLSearchParams(window.location.search);
        const modalUrl = urlParams.get('modal');
        
        if (modalUrl && window.openSnippetModal) {
            // Parse the modal URL to extract snippet info
            const snippetPath = new URL(modalUrl, window.location.origin).pathname;
            openSnippetFromUrl(snippetPath);
        }
        
        // Function to open snippet from URL
        async function openSnippetFromUrl(snippetUrl) {
            // Create an iframe to load the snippet content
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = snippetUrl + '?modal=true';
            
            // Listen for messages from the iframe
            const messageHandler = function(event) {
                if (event.data && event.data.type === 'snippetModalReady') {
                    // Remove event listener and iframe
                    window.removeEventListener('message', messageHandler);
                    document.body.removeChild(iframe);
                    
                    // Update URL to reflect the snippet
                    history.pushState({modal: true}, '', snippetUrl);
                    
                    // Open modal with the received data
                    window.openSnippetModal({
                        title: event.data.title || 'Untitled Snippet',
                        language: event.data.language || '',
                        content: event.data.content || '',
                        date: event.data.date || '',
                        tags: event.data.tags || [],
                        hasMathFormulas: event.data.content && (
                            event.data.content.includes('data-latex') || 
                            event.data.content.includes('class="math"') ||
                            event.data.content.includes('\\(') || 
                            event.data.content.includes('\\[') ||
                            event.data.content.includes('$$') ||
                            event.data.content.includes('\\begin{') ||
                            event.data.content.includes('\\\\(') ||
                            event.data.content.includes('\\\\[')
                        )
                    });
                }
            };
            
            window.addEventListener('message', messageHandler);
            document.body.appendChild(iframe);
        }
        
        // Add click handlers to grid cards
        const gridCards = document.querySelectorAll('.grid-card');
        
        gridCards.forEach(card => {
            // Make the entire card clickable
            card.style.cursor = 'pointer';
            
            // Create a function to handle modal opening
            const openModalForCard = function() {
                // Extract basic data from the card for immediate feedback
                const titleElement = card.querySelector('.card-title a, .card-title');
                const title = titleElement?.textContent?.trim() || 'Untitled Snippet';
                const language = card.querySelector('.card-language')?.textContent || '';
                const date = card.querySelector('.meta-date')?.textContent || '';
                const tags = Array.from(card.querySelectorAll('.card-tag')).map(tag => tag.textContent);
                
                // Get the content URL for the snippet
                const contentUrl = card.querySelector('.card-title a')?.getAttribute('href');
                
                // Always open modal for any card with a title
                if (title && title.trim() !== '' && contentUrl && contentUrl !== '#') {
                    if (window.openSnippetModal) {
                        // Show loading state in modal
                        window.openSnippetModal({
                            title: title,
                            language: language,
                            content: '<p>Loading content...</p>',
                            date: date,
                            tags: tags,
                            hasMathFormulas: false
                        });
                        
                        // Load full content using iframe approach
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = contentUrl + '?modal=true';
                        
                        // Listen for messages from the iframe
                        const messageHandler = function(event) {
                            if (event.data && event.data.type === 'snippetModalReady') {
                                // Remove event listener and iframe
                                window.removeEventListener('message', messageHandler);
                                document.body.removeChild(iframe);
                                
                                // Update URL to reflect the snippet
                                history.pushState({modal: true}, '', contentUrl);
                                
                                // Update modal with the received data
                                window.openSnippetModal({
                                    title: event.data.title || title,
                                    language: event.data.language || language,
                                    content: event.data.content || '<p>Content not available</p>',
                                    date: event.data.date || date,
                                    tags: event.data.tags || tags,
                                    hasMathFormulas: event.data.content && (
                                        event.data.content.includes('data-latex') || 
                                        event.data.content.includes('class="math"') ||
                                        event.data.content.includes('\\(') || 
                                        event.data.content.includes('\\[') ||
                                        event.data.content.includes('$$') ||
                                        event.data.content.includes('\\begin{') ||
                                        event.data.content.includes('\\\\(') ||
                                        event.data.content.includes('\\\\[')
                                    )
                                });
                            }
                        };
                        
                        window.addEventListener('message', messageHandler);
                        document.body.appendChild(iframe);
                    } else {
                        console.error('openSnippetModal function not available');
                    }
                }
            };
            
            // Add click handler to the card
            card.addEventListener('click', function(e) {
                // Prevent any default behavior
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                // Open modal
                openModalForCard();
            });
            
            // Prevent default link behavior and trigger modal
            const links = card.querySelectorAll('a');
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    // Open modal
                    openModalForCard();
                    
                    return false;
                }, true); // Use capture phase
            });
        });
    }, 200); // Wait for snippet_card_modal.js to initialize
});
</script>
{% endblock %}