{% extends "base.html" %}

{% block title %}Snippets - {{ site.title }}{% endblock %}

{% block extra_styles %}
<style>
.listing-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: var(--spacing-6, 1.5rem);
}

@media (max-width: 768px) {
  .listing-grid {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}

{% block content %}
{{ component(name="page_tags", title="Snippets") | safe }}

{% if snippets %}
<div class="listing-grid">
  {% for snippet in snippets %}
  {{ component(name="grid_card", page=snippet) | safe }}
  {% endfor %}
</div>
{% else %}
<div class="text-center" style="padding: var(--spacing-16) 0;">
  <p style="color: var(--text-secondary); font-size: var(--font-size-lg);">No snippets found.</p>
</div>
{% endif %}

<!-- Snippet Modal Component -->
{{ component(name="snippet_card_modal") | safe }}
{% endblock %}

{% block scripts %}


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Wait for snippet_card_modal.js to initialize
    setTimeout(() => {
        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            // If we're going back from a modal URL, close the modal
            if (window.closeSnippetModal) {
                const modalOverlay = document.querySelector('.snippet-modal-overlay');
                if (modalOverlay && modalOverlay.classList.contains('active')) {
                    window.closeSnippetModal();
                    // Go back to snippets.html
                    history.replaceState({}, '', '/snippets.html');
                }
            }
        });
        
        // Add click handlers to grid cards
        const gridCards = document.querySelectorAll('.grid-card');
        
        gridCards.forEach(card => {
            // Make the entire card clickable
            card.style.cursor = 'pointer';
            
            // Create a function to handle modal opening
            const openModalForCard = async function() {
                // Extract snippet data from the card
                const titleElement = card.querySelector('.card-title a, .card-title');
                const title = titleElement?.textContent?.trim() || 'Untitled Snippet';
                const language = card.querySelector('.card-language')?.textContent || '';
                const content = card.querySelector('.card-excerpt')?.textContent || '';
                const date = card.querySelector('.meta-date')?.textContent || '';
                const tags = Array.from(card.querySelectorAll('.card-tag')).map(tag => tag.textContent);
                
                // Get the full content for the modal
                const contentUrl = card.querySelector('.card-title a')?.getAttribute('href');
                let fullContent = content;
                let extractedLanguage = language;
                
                // Fetch the snippet.html page content
                if (contentUrl && contentUrl !== '#') {
                    try {
                        const response = await fetch(contentUrl);
                        if (response.ok) {
                            const html = await response.text();
                            
                            // Extract the content from snippet.html
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const snippetContent = doc.querySelector('.snippet-content');
                            
                            if (snippetContent) {
                                fullContent = snippetContent.innerHTML;
                                
                                // Extract language from code blocks if not already found
                                if (!extractedLanguage) {
                                    const codeBlock = snippetContent.querySelector('.code-block-component');
                                    if (codeBlock) {
                                        const langSpan = codeBlock.querySelector('.code-language');
                                        if (langSpan) {
                                            extractedLanguage = langSpan.textContent.trim();
                                        } else {
                                            const langAttr = codeBlock.getAttribute('data-language');
                                            if (langAttr) {
                                                extractedLanguage = langAttr;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Failed to fetch snippet.html:', err);
                    }
                }
                
                // Clean up content - remove h1 title and empty paragraphs
                fullContent = fullContent.replace(/<h1>.*?<\/h1>/, '').trim();
                fullContent = fullContent.replace(/^<p>\s*<\/p>/, '').trim();
                
                // Always open modal for any card with a title
                if (title && title.trim() !== '') {
                    if (window.openSnippetModal) {
                        // Update URL to reflect the snippet
                        if (contentUrl && contentUrl !== '#') {
                            history.pushState({modal: true}, '', contentUrl);
                        }
                        
                        window.openSnippetModal({
                            title: title,
                            language: extractedLanguage,
                            content: fullContent,
                            date: date,
                            tags: tags,
                            hasMathFormulas: fullContent.includes('class="math"') || 
                                            fullContent.includes('data-latex') ||
                                            fullContent.includes('\\(') || 
                                            fullContent.includes('\\[') ||
                                            fullContent.includes('$$') ||
                                            fullContent.includes('\\begin{') ||
                                            fullContent.includes('\\\\(') ||
                                            fullContent.includes('\\\\[')
                        });
                    } else {
                        console.error('openSnippetModal function not available');
                    }
                }
            };
            
            // Add click handler to the card
            card.addEventListener('click', function(e) {
                // Prevent any default behavior
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                // Open modal
                openModalForCard();
            });
            
            // Prevent default link behavior and trigger modal
            const links = card.querySelectorAll('a');
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    // Open modal
                    openModalForCard();
                    
                    return false;
                }, true); // Use capture phase
            });
        });
    }, 200); // Wait for snippet_card_modal.js to initialize
});
</script>
{% endblock %}