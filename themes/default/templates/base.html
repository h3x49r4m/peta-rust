<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="{{ config.site.base_url | safe }}/">
    <title>{% block title %}{{ site.title }} - {{ site.description }}{% endblock title %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="{{ asset_url(path='css/main.css', base_url=base_url) }}">

    <!-- Code Block Styles (generated from Rust) -->
    <link rel="stylesheet" href="{{ asset_url(path='assets/css/code-blocks.css', base_url=base_url) }}">

    <!-- Math Formula Styles (generated from Rust) -->
    <link rel="stylesheet" href="{{ asset_url(path='assets/css/math-formulas.css', base_url=base_url) }}">

    <!-- Embedded Snippet Card Styles (generated from Rust) -->
    <link rel="stylesheet" href="{{ asset_url(path='assets/css/embedded-snippet-cards.css', base_url=base_url) }}">

    <!-- Diagram Styles (generated from Rust) -->
    <link rel="stylesheet" href="{{ asset_url(path='assets/css/diagrams.css', base_url=base_url) }}">

    <!-- Music Score Styles (generated from Rust) -->
    <link rel="stylesheet" href="{{ asset_url(path='assets/css/music-scores.css', base_url=base_url) }}">

    <!-- Component Styles -->
    <style>
    {{ component_styles(component_names=["header", "navbar", "contacts", "grid_card", "tag_cloud", "footer", "page_tags", "snippet_card_modal", "content_div", "grid_cards", "article_toc", "article_content", "article_modal", "book_toc", "book_content", "book_modal", "project_toc", "project_content", "project_modal", "site_stats", "search_bar", "search_results", "back_to_top", "reading_progress", "share"]) | safe }}
    </style>
    
    {% block extra_styles %}{% endblock extra_styles %}
</head>
<body>
    <!-- Header -->
    {{ component(name="header") | safe }}
    
    <!-- Main Content -->
    <main class="main-content">
        <div class="content-div">
            {% block content %}{% endblock content %}
        </div>
    </main>
    
    <!-- Footer -->
    {{ component(name="footer", variant="default") | safe }}
    
    <!-- Back to Top Button -->
    {{ component(name="back_to_top") | safe }}
    
    <!-- External JavaScript -->
    <script src="{{ asset_url(path='js/main.js', base_url=base_url) }}"></script>

    <!-- Code Block Scripts (generated from Rust) -->
    <script src="{{ asset_url(path='assets/js/code-blocks.js', base_url=base_url) }}"></script>

    <!-- Math Formula Scripts (generated from Rust) -->
    <script src="{{ asset_url(path='assets/js/math-formulas.js', base_url=base_url) }}"></script>

    <!-- Embedded Snippet Card Scripts (generated from Rust) -->
    <script src="{{ asset_url(path='assets/js/embedded-snippet-cards.js', base_url=base_url) }}"></script>

    <!-- Diagram Scripts (generated from Rust) -->
    <script src="{{ asset_url(path='assets/js/diagrams.js', base_url=base_url) }}"></script>

    <!-- Music Score Scripts (generated from Rust) -->
    <script src="{{ asset_url(path='assets/js/music-scores.js', base_url=base_url) }}"></script>

    <!-- Component Scripts -->
    <script>
    {{ component_scripts(component_names=["header", "navbar", "contacts", "grid_card", "tag_cloud", "footer", "page_tags", "content_div", "grid_cards", "article_toc", "article_content", "article_modal", "book_toc", "book_content", "book_modal", "project_toc", "project_content", "project_modal", "search_bar", "search_results", "back_to_top", "reading_progress", "share"]) | safe }}
    </script>
    
    <!-- Snippet Modal Script -->
    <script>
    (function() {
        'use strict';
        
        // Initialize modal functionality
        function initSnippetModal() {
            const modalOverlay = document.querySelector('.snippet-modal-overlay');
            if (!modalOverlay) return;
            
            const closeBtn = modalOverlay.querySelector('.snippet-modal-close');
            const copyBtn = modalOverlay.querySelector('.snippet-modal-copy-btn');
            
            // Close modal when clicking close button
            if (closeBtn) {
                closeBtn.addEventListener('click', closeModal);
            }
            
            // Close modal when clicking overlay
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
                    closeModal();
                }
            });
            
            // Copy functionality
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    const content = copyBtn.getAttribute('data-copy-content');
                    if (!content) return;
                    
                    navigator.clipboard.writeText(content).then(function() {
                        // Show success state
                        copyBtn.classList.add('copied');
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Copied!
                        `;
                        
                        // Reset after 2 seconds
                        setTimeout(function() {
                            copyBtn.classList.remove('copied');
                            copyBtn.innerHTML = originalText;
                        }, 2000);
                    }).catch(function(err) {
                        console.error('Failed to copy: ', err);
                        // Show error state
                        copyBtn.style.backgroundColor = '#ef4444';
                        copyBtn.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            Failed!
                        `;
                        
                        // Reset after 2 seconds
                        setTimeout(function() {
                            copyBtn.style.backgroundColor = '';
                            copyBtn.innerHTML = originalText;
                        }, 2000);
                    });
                });
            }
        }
        
        // Open modal function
        window.openSnippetModal = function(snippet) {
            const modalOverlay = document.querySelector('.snippet-modal-overlay');
            if (!modalOverlay) return;
            
            // Update modal content
            const title = modalOverlay.querySelector('.snippet-modal-title');
            const language = modalOverlay.querySelector('.snippet-modal-language');
            const body = modalOverlay.querySelector('.snippet-modal-body');
            const date = modalOverlay.querySelector('.snippet-modal-date');
            const tagsContainer = modalOverlay.querySelector('.snippet-modal-tags');
            const copyBtn = modalOverlay.querySelector('.snippet-modal-copy-btn');
            
            if (title) title.textContent = snippet.title || 'Snippet';
            if (language) {
                if (snippet.language) {
                    language.textContent = snippet.language;
                    language.style.display = 'inline-block';
                } else {
                    language.style.display = 'none';
                }
            }
            
            if (body) {
                body.innerHTML = snippet.content || '<p>No content available</p>';
                
                // Check if content has math formulas and handle them using KaTeX
                const hasMathFormulas = snippet.content && (
                    snippet.content.includes('data-latex') || 
                    snippet.content.includes('class="math"') ||
                    snippet.content.includes('\\(') || 
                    snippet.content.includes('\\[') ||
                    snippet.content.includes('$$') ||
                    snippet.content.includes('\\begin{') ||
                    snippet.content.includes('\\\\(') ||
                    snippet.content.includes('\\\\[')
                );
                
                if (hasMathFormulas) {
                    console.log('Content has math formulas, ensuring KaTeX is loaded...');

                    // KaTeX is already loaded by math-formulas.js
                    // Just trigger render if needed
                    if (window.petaMathLoaded) {
                        const elements = body.querySelectorAll('[data-latex]');
                        elements.forEach(el => {
                            const latex = el.getAttribute('data-latex');
                            if (latex && window.katex) {
                                try {
                                    el.innerHTML = '';
                                    window.katex.render(latex, el, {
                                        displayMode: el.classList.contains('math-display'),
                                        throwOnError: false,
                                        trust: true
                                    });
                                } catch (e) {
                                    console.error('Math rendering error:', e);
                                }
                            }
                        });
                    }
                }
            }
            
            if (date) {
                if (snippet.date) {
                    date.textContent = snippet.date;
                    date.style.display = 'inline';
                } else {
                    date.style.display = 'none';
                }
            }
            if (tagsContainer && snippet.tags) {
                tagsContainer.innerHTML = snippet.tags.map(tag => 
                    `<span class="snippet-modal-tag">${tag}</span>`
                ).join('');
                tagsContainer.style.display = 'flex';
            } else if (tagsContainer) {
                tagsContainer.style.display = 'none';
            }
            if (copyBtn) {
                copyBtn.setAttribute('data-copy-content', snippet.content || '');
            }
            
            // Show modal
            modalOverlay.style.display = 'flex';
            // Force reflow
            modalOverlay.offsetHeight;
            modalOverlay.classList.add('active');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        };
        
        // Close modal function
        function closeModal() {
            const modalOverlay = document.querySelector('.snippet-modal-overlay');
            if (!modalOverlay) return;
            
            modalOverlay.classList.remove('active');
            
            setTimeout(function() {
                modalOverlay.style.display = 'none';
                // Restore body scroll
                document.body.style.overflow = '';
                
                // Update URL back to snippets page
                const snippetsUrl = "{{ url(path='snippets.html', base_url=base_url) }}";
                if (window.location.pathname !== snippetsUrl) {
                    history.replaceState({}, '', snippetsUrl);
                }
            }, 300);
        }
        
        // Make closeModal globally available
        window.closeSnippetModal = closeModal;

        // Set base_url for JavaScript to use
        window.PETA_BASE_URL = "{{ base_url | safe }}";
        
        // Initialize on DOM content loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initSnippetModal);
        } else {
            initSnippetModal();
        }
    })();
    </script>

{% block scripts %}{% endblock scripts %}
</body>
</html>
